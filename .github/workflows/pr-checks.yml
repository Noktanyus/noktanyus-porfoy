name: ğŸ” Enhanced PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ "master", "main" ]

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'

jobs:
  # ğŸ“ PR Information & Analysis
  pr-info:
    name: ğŸ“ PR Information & Analysis
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.changes.outputs.has-changes }}
      changed-files: ${{ steps.changes.outputs.changed-files }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ PR Details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            console.log(`ğŸ”„ PR #${pr.number}: ${pr.title}`);
            console.log(`ğŸ‘¤ Author: ${pr.user.login}`);
            console.log(`ğŸŒ¿ Branch: ${pr.head.ref} â†’ ${pr.base.ref}`);
            console.log(`ğŸ“Š Changes: +${pr.additions} -${pr.deletions}`);
            
            // Add PR info to summary
            core.summary
              .addHeading('ğŸ”„ Pull Request Information')
              .addTable([
                [{data: 'Property', header: true}, {data: 'Value', header: true}],
                ['PR Number', `#${pr.number}`],
                ['Title', pr.title],
                ['Author', pr.user.login],
                ['Branch', `${pr.head.ref} â†’ ${pr.base.ref}`],
                ['Changes', `+${pr.additions} -${pr.deletions}`],
                ['Files Changed', pr.changed_files.toString()],
                ['Status', pr.draft ? 'ğŸ“ Draft' : 'âœ… Ready for Review']
              ])
              .write();

      - name: ğŸ” Analyze changed files
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -n "$CHANGED_FILES" ]; then
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "## ğŸ“ Changed Files" >> $GITHUB_STEP_SUMMARY
            echo "$CHANGED_FILES" | while read file; do
              if [ -n "$file" ]; then
                echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No files changed" >> $GITHUB_STEP_SUMMARY
          fi

  # ğŸ” Code Quality Analysis
  code-analysis:
    name: ğŸ” Code Quality Analysis
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-changes == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: |
          echo "## ğŸ” ESLint Analysis" >> $GITHUB_STEP_SUMMARY
          if npm run lint; then
            echo "âœ… No linting errors found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Linting errors found. Please fix them before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: ğŸ“Š Code complexity analysis
        run: |
          echo "## ğŸ“Š Code Complexity" >> $GITHUB_STEP_SUMMARY
          
          # Count TypeScript/JavaScript files
          TS_FILES=$(find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | wc -l)
          TOTAL_LINES=$(find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -exec wc -l {} + | tail -1 | awk '{print $1}')
          
          echo "- **TypeScript/JavaScript files**: $TS_FILES" >> $GITHUB_STEP_SUMMARY
          echo "- **Total lines of code**: $TOTAL_LINES" >> $GITHUB_STEP_SUMMARY
          
          # Check for large files
          echo "### ğŸ“ Large Files (>500 lines):" >> $GITHUB_STEP_SUMMARY
          find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -exec wc -l {} + | \
          awk '$1 > 500 {print "- **" $2 "**: " $1 " lines"}' >> $GITHUB_STEP_SUMMARY || \
          echo "âœ… No large files found!" >> $GITHUB_STEP_SUMMARY

  # ğŸ”’ Security Check
  security-check:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-changes == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ”’ Run security audit
        run: |
          echo "## ğŸ”’ Security Audit" >> $GITHUB_STEP_SUMMARY
          
          if npm audit --audit-level=moderate --json > audit-results.json 2>/dev/null; then
            echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          else
            # Process audit results
            if [ -s audit-results.json ]; then
              VULNERABILITIES=$(jq -r '.metadata.vulnerabilities | to_entries[] | select(.value > 0) | "\(.key): \(.value)"' audit-results.json 2>/dev/null || echo "")
              if [ -n "$VULNERABILITIES" ]; then
                echo "âš ï¸ **Security vulnerabilities found:**" >> $GITHUB_STEP_SUMMARY
                echo "$VULNERABILITIES" | while read line; do
                  echo "- $line" >> $GITHUB_STEP_SUMMARY
                done
                
                # Check for critical/high vulnerabilities
                CRITICAL=$(jq -r '.metadata.vulnerabilities.critical // 0' audit-results.json 2>/dev/null || echo "0")
                HIGH=$(jq -r '.metadata.vulnerabilities.high // 0' audit-results.json 2>/dev/null || echo "0")
                
                if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âŒ **Critical or high severity vulnerabilities found. Please fix before merging.**" >> $GITHUB_STEP_SUMMARY
                  exit 1
                fi
              else
                echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âœ… No security vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # ğŸ—ï¸ Build Verification
  build-check:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-changes == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“ Setup build environment
        run: |
          cat > .env.local << EOF
          NEXTAUTH_SECRET=pr-build-secret-key
          DATABASE_URL=file:./pr-build.db
          NEXTAUTH_URL=http://localhost:3000
          ADMIN_EMAIL=admin@example.com
          ADMIN_PASSWORD=admin123
          NEXT_PUBLIC_BASE_URL=http://localhost:3000
          EMAIL_SERVER=smtp.example.com
          EMAIL_PORT=587
          EMAIL_USER=test@example.com
          EMAIL_PASSWORD=testpassword
          TURNSTILE_SECRET_KEY=test-turnstile-secret
          NEXT_PUBLIC_TURNSTILE_SITE_KEY=test-turnstile-site-key
          EOF

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate --schema=./prisma/schema.prisma

      - name: ğŸ—ï¸ Build application
        run: |
          echo "## ğŸ—ï¸ Build Verification" >> $GITHUB_STEP_SUMMARY
          
          if npm run build; then
            echo "âœ… Build completed successfully!" >> $GITHUB_STEP_SUMMARY
            
            # Analyze build output
            if [ -d ".next" ]; then
              echo "### ğŸ“¦ Build Output Analysis:" >> $GITHUB_STEP_SUMMARY
              
              # Static pages
              STATIC_PAGES=$(find .next -name "*.html" | wc -l)
              echo "- **Static pages generated**: $STATIC_PAGES" >> $GITHUB_STEP_SUMMARY
              
              # Bundle sizes
              echo "- **JavaScript bundles**:" >> $GITHUB_STEP_SUMMARY
              find .next/static -name "*.js" -type f -exec du -h {} + 2>/dev/null | \
              sort -hr | head -5 | while read size file; do
                echo "  - $(basename $file): $size" >> $GITHUB_STEP_SUMMARY
              done || echo "  - No JS bundles found" >> $GITHUB_STEP_SUMMARY
              
              # CSS files
              echo "- **CSS files**:" >> $GITHUB_STEP_SUMMARY
              find .next/static -name "*.css" -type f -exec du -h {} + 2>/dev/null | \
              sort -hr | head -3 | while read size file; do
                echo "  - $(basename $file): $size" >> $GITHUB_STEP_SUMMARY
              done || echo "  - No CSS files found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Build failed! Please fix the build errors before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        env:
          SKIP_ENV_VALIDATION: true

  # ğŸ§ª Test Execution
  test-execution:
    name: ğŸ§ª Test Execution
    runs-on: ubuntu-latest
    needs: pr-info
    if: needs.pr-info.outputs.has-changes == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“ Setup test environment
        run: |
          cat > .env.test << EOF
          NEXTAUTH_SECRET=test-secret-for-pr
          DATABASE_URL=file:./test.db
          NEXTAUTH_URL=http://localhost:3000
          ADMIN_EMAIL=test@example.com
          ADMIN_PASSWORD=testpassword
          EMAIL_SERVER=smtp.example.com
          EMAIL_PORT=587
          EMAIL_USER=test@example.com
          EMAIL_PASSWORD=testpassword
          TURNSTILE_SECRET_KEY=test-turnstile-secret
          NEXT_PUBLIC_TURNSTILE_SITE_KEY=test-turnstile-site-key
          EOF

      - name: ğŸ§ª Check for test files and run tests
        run: |
          echo "## ğŸ§ª Test Execution" >> $GITHUB_STEP_SUMMARY
          
          # Check if test files exist
          if find . -name "*.test.*" -o -name "*.spec.*" | grep -q .; then
            echo "ğŸ“ Test files found, executing tests..." >> $GITHUB_STEP_SUMMARY
            
            if npm run test --if-present; then
              echo "âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Some tests failed! Please fix them before merging." >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "â„¹ï¸ No test files found in the project." >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ Consider adding tests to improve code quality!" >> $GITHUB_STEP_SUMMARY
          fi

  # ğŸ“Š Performance Impact
  performance-impact:
    name: ğŸ“Š Performance Impact
    runs-on: ubuntu-latest
    needs: [pr-info, build-check]
    if: needs.pr-info.outputs.has-changes == 'true' && needs.build-check.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“ Setup build environment
        run: |
          cat > .env.local << EOF
          NEXTAUTH_SECRET=perf-test-secret
          DATABASE_URL=file:./perf-test.db
          NEXTAUTH_URL=http://localhost:3000
          ADMIN_EMAIL=admin@example.com
          ADMIN_PASSWORD=admin123
          NEXT_PUBLIC_BASE_URL=http://localhost:3000
          EMAIL_SERVER=smtp.example.com
          EMAIL_PORT=587
          EMAIL_USER=test@example.com
          EMAIL_PASSWORD=testpassword
          TURNSTILE_SECRET_KEY=test-turnstile-secret
          NEXT_PUBLIC_TURNSTILE_SITE_KEY=test-turnstile-site-key
          EOF

      - name: ğŸ—„ï¸ Generate Prisma Client
        run: npx prisma generate --schema=./prisma/schema.prisma

      - name: ğŸ—ï¸ Build for performance analysis
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true

      - name: ğŸ“Š Performance analysis
        run: |
          echo "## ğŸ“Š Performance Impact Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -d ".next" ]; then
            # Total build size
            BUILD_SIZE=$(du -sh .next | cut -f1)
            echo "- **Total build size**: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
            
            # Page count
            PAGE_COUNT=$(find .next -name "*.html" | wc -l)
            echo "- **Static pages**: $PAGE_COUNT" >> $GITHUB_STEP_SUMMARY
            
            # Largest bundles
            echo "### ğŸ¯ Largest JavaScript Bundles:" >> $GITHUB_STEP_SUMMARY
            find .next/static -name "*.js" -type f -exec du -h {} + 2>/dev/null | \
            sort -hr | head -5 | while read size file; do
              echo "- **$(basename $file)**: $size" >> $GITHUB_STEP_SUMMARY
            done || echo "- No JavaScript bundles found" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **Performance Tips:**" >> $GITHUB_STEP_SUMMARY
            echo "- Monitor bundle sizes to avoid performance regressions" >> $GITHUB_STEP_SUMMARY
            echo "- Consider code splitting for large components" >> $GITHUB_STEP_SUMMARY
            echo "- Use dynamic imports for non-critical code" >> $GITHUB_STEP_SUMMARY
          fi

  # âœ… Final PR Status
  pr-status:
    name: âœ… Final PR Status
    runs-on: ubuntu-latest
    needs: [pr-info, code-analysis, security-check, build-check, test-execution, performance-impact]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate PR status report
        run: |
          echo "# ğŸ” PR Quality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Check Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Required |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ PR Info | ${{ needs.pr-info.result == 'success' && 'âœ… Success' || 'âŒ Failed' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” Code Analysis | ${{ needs.code-analysis.result == 'success' && 'âœ… Success' || needs.code-analysis.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security Check | ${{ needs.security-check.result == 'success' && 'âœ… Success' || needs.security-check.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ—ï¸ Build Check | ${{ needs.build-check.result == 'success' && 'âœ… Success' || needs.build-check.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ§ª Tests | ${{ needs.test-execution.result == 'success' && 'âœ… Success' || needs.test-execution.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š Performance | ${{ needs.performance-impact.result == 'success' && 'âœ… Success' || needs.performance-impact.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} | â„¹ï¸ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ‰ All critical checks passed
        if: |
          needs.pr-info.result == 'success' && 
          (needs.code-analysis.result == 'success' || needs.code-analysis.result == 'skipped') && 
          (needs.security-check.result == 'success' || needs.security-check.result == 'skipped') && 
          (needs.build-check.result == 'success' || needs.build-check.result == 'skipped')
        run: |
          echo "## ğŸ‰ PR Ready for Review!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All critical quality checks have passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”„ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Request review from team members" >> $GITHUB_STEP_SUMMARY
          echo "2. Address any review feedback" >> $GITHUB_STEP_SUMMARY
          echo "3. Merge when approved" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Some critical checks failed
        if: |
          needs.pr-info.result == 'failure' || 
          needs.code-analysis.result == 'failure' || 
          needs.security-check.result == 'failure' || 
          needs.build-check.result == 'failure'
        run: |
          echo "## âŒ PR Needs Attention!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some critical checks failed. Please fix the issues before requesting review:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.code-analysis.result }}" == "failure" ]]; then
            echo "- ğŸ” **Code Analysis**: Fix linting errors" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.security-check.result }}" == "failure" ]]; then
            echo "- ğŸ”’ **Security Check**: Address security vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.build-check.result }}" == "failure" ]]; then
            echo "- ğŸ—ï¸ **Build Check**: Fix build errors" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-execution.result }}" == "failure" ]]; then
            echo "- ğŸ§ª **Tests**: Fix failing tests" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **Tip**: Check the individual job logs above for detailed error information." >> $GITHUB_STEP_SUMMARY
          exit 1